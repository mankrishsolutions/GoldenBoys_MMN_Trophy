<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team Registration â€“ MMN Golden Boys</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005BEA">

    <style>
        body {
            background: #f4f6f9;
            font-family: "Segoe UI", sans-serif;
            padding: 20px;
        }

        .main-card {
            max-width: 900px;
            margin: auto;
            border-radius: 18px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            overflow: hidden;
            background: #fff;
        }

        .header-banner {
            background: linear-gradient(90deg, #005BEA, #00C6FB);
            padding: 22px 15px;
            text-align: center;
            color: white;
        }

        .header-logo {
            width: 100px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            margin-bottom: 8px;
        }

        .section-title {
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .counter-box {
            background: #e8f3ff;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
        }

        .player-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="main-card">

    <!-- HEADER -->
    <div class="header-banner">
        <img src="GoldenBoys.jpg" class="header-logo">
        <h5 class="fw-bold mb-0">MMN Golden Boys</h5>
        <small>Champions Trophy</small>
    </div>

    <!-- BODY -->
    <div class="card-body p-4">
        <form id="teamForm">

            <!-- TEAM DETAILS -->
            <h5 class="section-title">Team Details</h5>

            <select class="form-select mb-2" id="teamName" required>
                <option value="">Select Team</option>
            </select>

            <input class="form-control mb-2" id="captainName" placeholder="Captain Name" required>
            <input class="form-control mb-2" id="captainMobile" placeholder="Captain Mobile"
                   maxlength="10"
                   oninput="this.value = this.value.replace(/[^0-9]/g,'').slice(0,10);"
                   required>

            <select class="form-select mb-2" id="paymentMode" onchange="togglePaymentFields()">
                <option value="Cash">Cash</option>
                <option value="Online">Online</option>
            </select>

            <input class="form-control mb-2" id="paymentAmount" placeholder="Enter Payment Amount (â‚¹)">

            <p id="paymentMsg" class="text-danger small" style="display:none;">
                *** Please attach a payment screenshot for Online mode.
            </p>

            <div id="paymentScreenshotDiv" style="display:none;">
                <input type="file" class="form-control mb-2" id="paymentScreenshot">
            </div>

            <hr>

            <!-- PLAYER SECTION -->
            <h5 class="section-title">Players</h5>

            <div class="counter-box mb-3">
                Players Added: <span id="playerCount">0</span> / 15
            </div>

            <div id="playerForms"></div>

			<button type="button"
					id="addPlayerBtn"
					class="btn btn-primary w-100 mb-3"
					onclick="addPlayerForm()"
					disabled>
				âž• Add Player
			</button>

            <button type="button" class="btn btn-success w-100"
                    onclick="submitTeam()">
                âœ… Submit Team
            </button>

        </form>
    </div>
</div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbwE-fiDQn2TzNlDSNLi4m42J6f9lZQcoJZ20Kc8fDKJd3ejt8MPhozOXqn3_YRHJ9Ovdw/exec";
let playerCount = 0;        // total existing + new
let savedPlayerCount = 0;  // players already saved
const maxPlayers = 15;

window.addEventListener("load", () => {
    paymentMode.value = "Online";
    paymentMode.disabled = true;

    paymentAmount.value = "3500";
    paymentAmount.disabled = true;

    togglePaymentFields();
    disablePlayerActions(true);
});

function isPaymentValid() {
    if (paymentMode.value !== "Online") {
        alert("Only Online payment is allowed.");
        return false;
    }

    if (paymentAmount.value !== "3500") {
        alert("Payment amount must be exactly â‚¹3500.");
        return false;
    }

    if (!paymentScreenshot.files || !paymentScreenshot.files[0]) {
        alert("Please upload payment screenshot.");
        return false;
    }

    return true;
}

function disablePlayerActions(disable) {
    document.getElementById("addPlayerBtn").disabled = disable;
    document.getElementById("submitBtn").disabled = disable;
}

paymentScreenshot.addEventListener("change", () => {
    if (isPaymentValid()) {
        disablePlayerActions(false);
    }
});

// Convert image to Base64
function fileToBase64(file) {
  return new Promise((resolve) => {
    if (!file) return resolve("");
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

// Show/hide payment fields
function togglePaymentFields() {
  if (paymentMode.value === "Online") {
    paymentMsg.style.display = "block";
    paymentScreenshotDiv.style.display = "block";
  } else {
    paymentMsg.style.display = "none";
    paymentScreenshotDiv.style.display = "none";
  }
}

// Load team dropdown
async function loadTeams() {
  const res = await fetch(apiURL + "?action=getTeams");
  const teams = await res.json();
  const ddl = document.getElementById("teamName");
  
  document.getElementById("teamName").onchange = loadPlayerCount;
  document.getElementById("teamName").onchange = onTeamSelect;
  
  ddl.innerHTML = `<option value="">Select Team</option>`;
  teams.forEach(t => {
    let o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    ddl.appendChild(o);
  });
}
loadTeams();

// Add player form card
function addPlayerForm() {
  if (playerCount >= maxPlayers) return alert("Max 15 players allowed");
	playerCount++;
	document.getElementById("playerCount").innerText = playerCount;

  const div = document.createElement("div");
  div.className = "player-card";

  div.innerHTML = `
    <h6>Player ${playerCount}</h6>
    <input class="form-control mb-2 p_name" placeholder="Player Name" required>
    <input class="form-control mb-2 p_age" type="number" placeholder="Age" required>
    <input class="form-control mb-2 p_mobile" placeholder="Mobile" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g,'').slice(0,10);" required>
    <input class="form-control mb-2 p_aadhaar" placeholder="Aadhaar" oninput="formatAadhaar(this)" required>
    <label class="form-label">Aadhaar Image</label>
	<input type="file" class="form-control mb-2 p_aadhaar_img" onchange="previewAdhaarImg(this)">
	<img class="img-thumbnail mb-3" style="display:none;width:80px;height:80px;">

	<label class="form-label">Player Photo</label>
	<input type="file" class="form-control mb-2 p_player_img" onchange="previewPlayerImg(this)">
	<img class="img-thumbnail mb-3" style="display:none;width:80px;height:80px;">

    <button type="button" class="btn btn-success w-100" onclick="savePlayer(this)">Save Player</button>
  `;

  document.getElementById("playerForms").appendChild(div);
}

function previewPlayerImg(input) {
  const img = input.nextElementSibling;
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    img.src = e.target.result;
    img.style.display = "block";
  };
  reader.readAsDataURL(file);
}

function previewAdhaarImg(input) {
  const img = input.nextElementSibling;
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    img.src = e.target.result;
    img.style.display = "block";
  };
  reader.readAsDataURL(file);
}


// Save player -> Google Sheet + Drive
async function savePlayer(btn) {

  const card = btn.closest(".player-card");

  const aadhaarFile = card.querySelector(".p_aadhaar_img").files[0];
  const playerFile  = card.querySelector(".p_player_img").files[0];

  const aadhaarBase64 = await fileToBase64(aadhaarFile);
  const playerBase64  = await fileToBase64(playerFile);

  const player = {
    name: card.querySelector(".p_name").value,
    age: card.querySelector(".p_age").value,
    mobile: card.querySelector(".p_mobile").value,
    aadhaar: card.querySelector(".p_aadhaar").value,
    aadhaarBase64: aadhaarBase64,
    playerImageBase64: playerBase64
  };
  
	// Validate mobile number (10 digits)
	if (!/^[0-9]{10}$/.test(card.querySelector(".p_mobile").value)) {
	  alert("Enter valid 10-digit mobile number");
	  return;
	}

	if (!/^\d{4} \d{4} \d{4}$/.test(card.querySelector(".p_aadhaar").value)) {
	  alert("Aadhaar must be in format XXXX XXXX XXXX");
	  return;
	}

  const payload = {
    type: "player",
    teamName: teamName.value,
    captainName: captainName.value,
    captainMobile: captainMobile.value,
    paymentMode: paymentMode.value,
    paymentAmount: paymentAmount.value,
    player: player
  };

  await fetch(apiURL, { method: "POST", body: JSON.stringify(payload) });
  card.remove();
}

function formatAadhaar(input) {
  let v = input.value.replace(/\D/g, "").substring(0,12);
  v = v.replace(/(.{4})/g, "$1 ").trim();
  input.value = v;
}

async function loadPlayerCount() {
    const team = teamName.value;
    if (!team) return;

    const res = await fetch(apiURL + "?action=getPlayerCount&team=" + encodeURIComponent(team));
    const data = await res.json();

    playerCount = data.count;
    savedPlayerCount = data.count;

    document.getElementById("playerCount").innerText = playerCount;
    updateSubmitButton();
}

async function onTeamSelect() {
    const team = teamName.value;
    if (!team) return;

    // Fetch basic captain info
    const infoRes = await fetch(apiURL + "?action=getTeamBasicInfo&team=" + encodeURIComponent(team));
    const info = await infoRes.json();

    // Auto-fill values
    captainName.value = info.captainName || "";
    captainMobile.value = info.captainMobile || "";
    paymentMode.value = info.paymentMode || "Cash";
    paymentAmount.value = info.paymentAmount || "";

    // Update UI visibility based on payment mode
    togglePaymentFields();

    // Load player count
    loadPlayerCount();
}

// Final submit
async function submitTeam() {

	  let screenshotBase64 = "";
	  
	  if (paymentMode.value === "Online" && !paymentScreenshot.files[0]) {
		alert("Upload payment screenshot!");
		return;
	  }
	  const f = paymentScreenshot.files[0];
	  screenshotBase64 = await fileToBase64(f);

  const payload = {
    type: "teamSubmit",
    teamName: teamName.value,
    captainName: captainName.value,
    captainMobile: captainMobile.value,
    paymentMode: paymentMode.value,
    paymentAmount: paymentAmount.value,
    paymentScreenshotBase64: screenshotBase64
  };

  await fetch(apiURL, { method: "POST", body: JSON.stringify(payload) });

  alert("Team Successfully Registered!");
  location.href = "success.html";
}
</script>
<!-- Service Worker (Auto Update Enabled) -->
<script>
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
            .then(registration => {

                // ðŸ”„ Check for updates on every load
                registration.update();

                // ðŸ‘‚ Listen for new service worker
                registration.addEventListener("updatefound", () => {
                    const newWorker = registration.installing;

                    if (newWorker) {
                        newWorker.addEventListener("statechange", () => {
                            if (
                                newWorker.state === "installed" &&
                                navigator.serviceWorker.controller
                            ) {
                                // ðŸš€ New version available â†’ reload
                                console.log("ðŸ”„ New version available. Reloading...");
                                window.location.reload();
                            }
                        });
                    }
                });
            })
            .catch(err => {
                console.error("Service Worker registration failed:", err);
            });
    });
}
	
self.addEventListener("install", event => {
self.skipWaiting();
});

self.addEventListener("activate", event => {
    event.waitUntil(
        caches.keys().then(keys =>
            Promise.all(
                keys.map(key => caches.delete(key))
            )
        )
    );
    self.clients.claim();
});
</script>
<script src="app.js?v=20251213"></script>
</body>
</html>

