<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Team Registration ‚Äì MMN Golden Boys</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">


	<link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
	<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
	
	<!-- Header Styles -->
	<style>
	.header-banner-img {
		width: 100%;
		height: 160px;
		overflow: hidden;
		border-radius: 18px 18px 0 0;
		position: relative;
	}

	/* Banner image */
	.header-banner-img img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		object-position: center top;
		display: block;
	}

	/* Back button ‚Äì always ABOVE image */
	.back-btn {
		position: absolute;
		top: 12px;
		right: 12px;
		z-index: 5;                       /* üî• THIS FIXES IT */
		background: rgba(255,255,255,0.95);
		border-radius: 20px;
		padding: 4px 12px;
		font-weight: 500;
		box-shadow: 0 4px 10px rgba(0,0,0,0.25);
		border: none;
	}

	/* Mobile */
	@media (max-width: 576px) {
		.header-banner-img {
			height: 110px;
		}

		.back-btn {
			top: 8px;
			right: 8px;
			font-size: 0.85rem;
		}
	}

	</style>
	
    <style>
        body {
            background: #f4f6f9;
            font-family: "Segoe UI", sans-serif;
            padding: 5px;
        }

        .main-card {
            max-width: 900px;
            margin: auto;
            border-radius: 18px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
            overflow: hidden;
            background: #fff;
        }

        .section-title {
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .counter-box {
            background: #e8f3ff;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
        }

        .player-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
		
		#loadingOverlay {
		  position: fixed;
		  top: 0; left: 0;
		  width: 100%; height: 100%;
		  background: rgba(255,255,255,0.7);
		  display: none;
		  align-items: center;
		  justify-content: center;
		  z-index: 9999;
		}

		#loadingOverlay img {
		  width: 100px;
		  height: 100px;
		}

    </style>
</head>
<body>

<div class="main-card">

	<!-- HEADER BANNER -->
	<div class="header-banner-img">
		<img src="banner.jpg" alt="MMN Golden Boys Champions Trophy">

		<button class="btn btn-light btn-sm back-btn"
				onclick="window.location.assign('index.html')">
			‚Üê Back
		</button>
	</div>


    <!-- BODY -->
    <div class="card-body p-4">
        <form id="teamForm">

            <!-- TEAM DETAILS -->
            <h5 class="section-title">Golden Boys - Team Registration Page</h5>

            <select class="form-select mb-2" id="teamName" required>
                <option value="">Select Team</option>
            </select>

            <input class="form-control mb-2" id="captainName" placeholder="Captain Name" required>
            <input class="form-control mb-2" id="captainMobile" placeholder="Captain Mobile"
                   maxlength="10"
                   oninput="this.value = this.value.replace(/[^0-9]/g,'').slice(0,10);"
                   required>
			
			<input class="form-control mb-2" id="paymentMode" text="payment Mode" required>


            <input class="form-control mb-2" id="paymentAmount" placeholder="Enter Payment Amount (‚Çπ)">

			<p id="paymentMsg" class="text-danger small">
				*** Please attach a payment screenshot on Final Submit Button. 
				Final Registration will only be accepted once the payment screenshot is verified by the Committee!
			</p>

            <div id="paymentScreenshotDiv" style="display:none;">
                <input type="file" class="form-control mb-2" id="paymentScreenshot">
            </div>

            <hr>

            <!-- PLAYER SECTION -->
            <h5 class="section-title">Players</h5>

            <div class="counter-box mb-3">
                Players Added: <span id="playerCount">0</span> / 15
            </div>

            <div id="playerForms"></div>

			<button type="button"
					id="addPlayerBtn"
					class="btn btn-primary w-100 mb-3"
					onclick="addPlayerForm()"
					disabled>
				‚ûï Add Player
			</button>

			<button type="button"
					id="submitBtn"
					class="btn btn-success w-100 mb-3"
					onclick="submitTeam()"
					style="display:none">
				‚úÖ Submit Team
			</button>
			

        </form>
		
		<div class="text-center mb-2">
			<button class="btn btn-outline-secondary btn-sm"
					onclick="togglePlayersList()"
					id="togglePlayersBtn">
				Show Team Players
			</button>
		</div>

		<div id="teamPlayersBox" class="border rounded p-2" style="display:none;">
			<ul id="teamPlayersList" class="mb-0"></ul>
		</div>
		
		<div class="footer-text mt-4">
			¬© 2026 Golden Boys
		</div>
		
		<div id="loadingOverlay">
			<img src="PercentLoading.gif" alt="Loading...">
		 </div>
    </div>
</div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbwE-fiDQn2TzNlDSNLi4m42J6f9lZQcoJZ20Kc8fDKJd3ejt8MPhozOXqn3_YRHJ9Ovdw/exec";
let playerCount = 0;        // total existing + new
let savedPlayerCount = 0;  // players already saved
const maxPlayers = 15;
let playersLoaded = false;
let iconPlayerExists = false;

window.addEventListener("load", () => {
    paymentMode.value = "Online";
    paymentMode.disabled = true;

    paymentAmount.value = "3500";
    paymentAmount.disabled = true;

    disablePlayerActions(true);
});

function isPaymentValid() {
    if (paymentMode.value !== "Online") {
        alert("Only Online payment is allowed.");
        return false;
    }

    if (paymentAmount.value !== "3500") {
        alert("Payment amount must be exactly ‚Çπ3500.");
        return false;
    }

    if (!paymentScreenshot.files || !paymentScreenshot.files[0]) {
        alert("Please upload payment screenshot.");
        return false;
    }

    return true;
}

function disablePlayerActions(disable) {
    document.getElementById("addPlayerBtn").disabled = disable;
}

paymentScreenshot.addEventListener("change", () => {
    if (isPaymentValid()) {
        disablePlayerActions(false);
    }
    updateSubmitButton();
});

// Convert image to Base64
function fileToBase64(file) {
  return new Promise((resolve) => {
    if (!file) return resolve("");
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

// Show/hide payment fields
function togglePaymentFields() {
  if (paymentMode.value === "Online") {
    paymentMsg.style.display = "block";
    paymentScreenshotDiv.style.display = "block";
  } else {
    paymentMsg.style.display = "none";
    paymentScreenshotDiv.style.display = "none";
  }
}

// Load team dropdown
async function loadTeams() {
showLoading();
  const res = await fetch(apiURL + "?action=getTeams");
  const teams = await res.json();
  const ddl = document.getElementById("teamName");
  
  document.getElementById("teamName").addEventListener("change", loadPlayerCount);
  document.getElementById("teamName").addEventListener("change", onTeamSelect);
  
  ddl.innerHTML = `<option value="">Select Team</option>`;
  teams.forEach(t => {
    let o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    ddl.appendChild(o);
  });
hideLoading();
}

loadTeams();

// Check if Icon Player already exists for this team
async function checkIconPlayerStatus() {
    iconPlayerExists = false;

    const team = teamName.value;
    if (!team) return;

    const players = await (
        await fetch(apiURL + "?action=getTeamPlayers&team=" + encodeURIComponent(team))
    ).json();

    iconPlayerExists = players.some(p =>
        p.playerName && p.playerName.includes(" - Icon")
    );
}

// Add player form card
async function addPlayerForm() {

    // üîÅ If an existing player form is present ‚Üí save it first
    const existingCard = document.querySelector(".player-card");

    if (existingCard) {
        const fakeBtn = { closest: () => existingCard }; // üëà trick to reuse savePlayer
        await savePlayer(fakeBtn);
    }

    // ‚õî Stop if max reached AFTER save
    if (playerCount >= maxPlayers) {
        alert("Max 15 players allowed");
        return;
    }
	

    // ‚ûï Now add new empty form
    playerCount++;
    document.getElementById("playerCount").innerText = playerCount;
	updateAddPlayerButton();

    const div = document.createElement("div");
    div.className = "player-card";

    div.innerHTML = `
        <h6>Player ${playerCount}</h6>

        <div class="d-flex align-items-center gap-2 mb-2">
			<input class="form-control p_name" placeholder="Player Name" required>

			${
				iconPlayerExists
				? `` 
				: `
				<div class="form-check">
					<input class="form-check-input p_icon" type="checkbox">
					<label class="form-check-label small">Icon</label>
				</div>
				`
			}
		</div>
		
        <input class="form-control mb-2 p_age" type="number" placeholder="Age" required>

        <input class="form-control mb-2 p_mobile"
               placeholder="Mobile" maxlength="10"
               oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);"
               required>

        <input class="form-control mb-2 p_aadhaar"
               placeholder="Aadhaar"
               oninput="formatAadhaar(this)"
               required>

        <label class="form-label">Aadhaar Image</label>
        <input type="file" class="form-control mb-2 p_aadhaar_img" onchange="previewAdhaarImg(this)">
        <img class="img-thumbnail mb-3" style="display:none;width:80px;height:80px;">

        <label class="form-label">Player Photo</label>
        <input type="file" class="form-control mb-2 p_player_img" onchange="previewPlayerImg(this)">
        <img class="img-thumbnail mb-3" style="display:none;width:80px;height:80px;">
    `;

    document.getElementById("playerForms").appendChild(div);
}

	function updateAddPlayerButton() {

		const addBtn     = document.getElementById("addPlayerBtn");
		const submitBtn  = document.getElementById("submitBtn");
		const paymentDiv = document.getElementById("paymentScreenshotDiv");

		/**
		 * savedPlayerCount = players already saved in sheet
		 * playerCount      = saved + currently open form
		 */

		// Case 1: Less than 14 players saved ‚Üí normal flow
		if (savedPlayerCount < 14) {
			addBtn.style.display = "block";
			addBtn.disabled = false;

			submitBtn.style.display = "none";
			paymentDiv.style.display = "none";
			return;
		}

		// Case 2: 14 players saved, 15th player form OPEN
		if (savedPlayerCount === 14 && playerCount === 15) {
			addBtn.style.display = "none";          // ‚ùå no more players
			submitBtn.style.display = "block";     // ‚úÖ final submit
			paymentDiv.style.display = "block";    // ‚úÖ show screenshot
			return;
		}

		// Case 3: 14 players saved, but 15th form NOT added yet
		if (savedPlayerCount === 14 && playerCount === 14) {
			addBtn.style.display = "block";         // allow adding 15th
			addBtn.disabled = false;

			submitBtn.style.display = "none";
			paymentDiv.style.display = "none";
			return;
		}
	}

function previewPlayerImg(input) {
    const img = input.nextElementSibling;
    const card = input.closest(".player-card");
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        img.src = e.target.result;
        img.style.display = "block";
        checkPlayerImages(card);
    };
    reader.readAsDataURL(file);
}

function previewAdhaarImg(input) {
    const img = input.nextElementSibling;
    const card = input.closest(".player-card");
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        img.src = e.target.result;
        img.style.display = "block";
        checkPlayerImages(card);
    };
    reader.readAsDataURL(file);
}

function checkPlayerImages(card) {
    const aadhaarFile = card.querySelector(".p_aadhaar_img").files[0];
    const playerFile  = card.querySelector(".p_player_img").files[0];
	const Addbtn = document.getElementById("addPlayerBtn");
	
    if (aadhaarFile && playerFile) {
        Addbtn.disabled = false;
    } else {
        Addbtn.disabled = true;
    }
}

// Save player -> Google Sheet + Drive
async function savePlayer(btn) {
  showLoading();
  playersLoaded = false;

  const card = btn.closest(".player-card");

  const aadhaarFile = card.querySelector(".p_aadhaar_img").files[0];
  const playerFile  = card.querySelector(".p_player_img").files[0];

	// üîí Mandatory image validation
	if (!aadhaarFile) {
		alert("Please upload Aadhaar image for the player");
		return;
	}

	if (!playerFile) {
		alert("Please upload Player photo.");
		return;
	}
	
	const aadhaarBase64 = await compressImage(aadhaarFile);
	const playerBase64  = await compressImage(playerFile);


	let playerName = card.querySelector(".p_name").value.trim();

	const iconCheckbox = card.querySelector(".p_icon");
	if (iconCheckbox && iconCheckbox.checked) {
		playerName += " - Icon ‚úàÔ∏è";
		iconPlayerExists = true;   // lock for future players
	}
	
    const player = {
    name: playerName,
    age: card.querySelector(".p_age").value,
    mobile: card.querySelector(".p_mobile").value,
    aadhaar: card.querySelector(".p_aadhaar").value,
    aadhaarBase64: aadhaarBase64,
    playerImageBase64: playerBase64
  };
  
	// Validate mobile number (10 digits)
	if (!/^[0-9]{10}$/.test(card.querySelector(".p_mobile").value)) {
		alert("Enter valid 10-digit mobile number");
		return;
	}

	if (!/^\d{4} \d{4} \d{4}$/.test(card.querySelector(".p_aadhaar").value)) {
		alert("Aadhaar must be in format XXXX XXXX XXXX");
		return;
	}

  const payload = {
    type: "player",
    teamName: teamName.value,
    captainName: captainName.value,
    captainMobile: captainMobile.value,
    paymentMode: paymentMode.value,
    paymentAmount: paymentAmount.value,
    player: player
  };

	await fetch(apiURL, { method: "POST", body: JSON.stringify(payload) });

	savedPlayerCount++;
	updateSubmitButton();
	updateAddPlayerButton();
	
	// üîÑ Refresh team players list if visible
	const playersBox = document.getElementById("teamPlayersBox");
	if (playersBox && playersBox.style.display !== "none") {
		await loadTeamPlayersNames();
		playersLoaded = true;
	}
	
	card.remove();
	hideLoading();
}

function formatAadhaar(input) {
  let v = input.value.replace(/\D/g, "").substring(0,12);
  v = v.replace(/(.{4})/g, "$1 ").trim();
  input.value = v;
}

async function loadPlayerCount() {
    const team = teamName.value;
    if (!team) return;

    const res = await fetch(apiURL + "?action=getPlayerCount&team=" + encodeURIComponent(team));
    const data = await res.json();

    playerCount = data.count;
    savedPlayerCount = data.count;

    document.getElementById("playerCount").innerText = playerCount;
    updateSubmitButton();
}

async function onTeamSelect() {
    showLoading();
    playersLoaded = false;

    const team = teamName.value;
    if (!team) {
        hideLoading();
        return;
    }

    try {
        // ‚úÖ Run APIs in parallel
        const [infoRes, countRes] = await Promise.all([
            fetch(apiURL + "?action=getTeamBasicInfo&team=" + encodeURIComponent(team)),
            fetch(apiURL + "?action=getPlayerCount&team=" + encodeURIComponent(team))
        ]);

        const info = await infoRes.json();
        const countData = await countRes.json();

        // Fill captain info
        captainName.value = info.captainName || "";
        captainMobile.value = info.captainMobile || "";

        // Player count
        playerCount = countData.count;
        savedPlayerCount = countData.count;
        document.getElementById("playerCount").innerText = playerCount;

		togglePaymentFields(); 
        updateAddPlayerButton();
        updateSubmitButton();

        // ‚úÖ Icon check ONLY if needed
        await checkIconPlayerStatus();

    } catch (err) {
        console.error(err);
        alert("Failed to load team data");
    }

    hideLoading();
}

// Final submit
async function submitTeam() {
  showLoading();

  // üîí Validate screenshot FIRST
  if (!paymentScreenshot.files || !paymentScreenshot.files[0]) {
    alert("Please upload payment screenshot!");
    return;
  }

  // ‚úÖ Convert screenshot BEFORE any save
  const screenshotBase64 = await fileToBase64(paymentScreenshot.files[0]);

  // üîÅ Now save last unsaved player (if any)
  const existingCard = document.querySelector(".player-card");
  if (existingCard) {
    const fakeBtn = { closest: () => existingCard };
    await savePlayer(fakeBtn);
  }
  showLoading();
  
  const payload = {
    type: "teamSubmit",
    teamName: teamName.value,
    captainName: captainName.value.trim(),
    captainMobile: captainMobile.value,
    paymentMode: paymentMode.value,
    paymentAmount: paymentAmount.value,
    paymentScreenshotBase64: screenshotBase64
  };

  const res = await fetch(apiURL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const result = await res.text();

  alert("Last player saved sucessfully. Team registration completed here!");

  if (result === "TEAM_SUBMITTED") {
    // ‚úÖ DIRECT SUCCESS PAGE
    window.location.replace("success.html");
  } else {
    alert("Submit failed: " + result);
  }
    hideLoading();
}

function updateSubmitButton() {

    const submitBtn = document.getElementById("submitBtn");

    // Only after 14 players
    if (savedPlayerCount !== 14) {
        submitBtn.style.display = "none";
        return;
    }

    submitBtn.style.display = "block";
}

function compressImage(file, maxWidth = 800, quality = 0.7) {
    return new Promise(resolve => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = e => {
            img.src = e.target.result;
        };

        img.onload = () => {
            const canvas = document.createElement("canvas");
            const scale = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * scale;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.readAsDataURL(blob);
            }, "image/jpeg", quality);
        };

        reader.readAsDataURL(file);
    });
}

async function togglePlayersList() {

    const box = document.getElementById("teamPlayersBox");
    const btn = document.getElementById("togglePlayersBtn");

    if (box.style.display === "none") {
        box.style.display = "block";
        btn.innerText = "Hide Team Players";

        if (!playersLoaded) {
            await loadTeamPlayersNames();
            playersLoaded = true;
        }
    } else {
        box.style.display = "none";
        btn.innerText = "Show Team Players";
    }
}

async function loadTeamPlayersNames() {

    const list = document.getElementById("teamPlayersList");
    list.innerHTML = `<li class="text-muted">Loading...</li>`;

    const team = teamName.value;
    if (!team) {
        list.innerHTML = `<li class="text-muted">Select a team first</li>`;
        return;
    }

    const players = await (
        await fetch(apiURL + "?action=getTeamPlayers&team=" + encodeURIComponent(team))
    ).json();

    list.innerHTML = "";

    if (!players.length) {
        list.innerHTML = `<li class="text-muted">No players added yet</li>`;
        return;
    }

    players.forEach(p => {
        list.innerHTML += `<li>${p.playerName}</li>`;
    });
}

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}
</script>

</body>
</html>
